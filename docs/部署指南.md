# MediaMinder 部署指南

## 部署概述

本指南详细说明如何在不同环境中部署MediaMinder系统，包括开发环境、测试环境和生产环境的部署步骤。

## 系统要求

### 最低要求
- **操作系统**: Windows 10 版本1903或更高
- **.NET Runtime**: .NET 9.0 Runtime
- **内存**: 4GB RAM
- **存储**: 1GB可用磁盘空间
- **权限**: 管理员权限（用于安装Windows服务）

### 推荐配置
- **操作系统**: Windows 11 或 Windows Server 2022
- **.NET Runtime**: .NET 9.0 Runtime
- **内存**: 8GB RAM或更多
- **存储**: 10GB可用磁盘空间
- **USB端口**: 多个USB端口用于连接相机

## 部署架构

### 目录结构
```
C:\ProgramData\MediaMinder\
├── Photos\                      # 照片存储目录
├── Logs\                        # 日志目录
├── Config\                      # 配置目录（可选）
└── Temp\                        # 临时文件目录
```

### 服务架构
- **MediaMinder.Service**: Windows服务，后台运行
- **MediaMinder.UI**: 桌面应用，用户界面
- **命名管道**: 服务与UI之间的通信

## 部署步骤

### 1. 环境准备

#### 1.1 安装.NET 9.0 Runtime
```powershell
# 下载并安装.NET 9.0 Runtime
# 从 https://dotnet.microsoft.com/download/dotnet/9.0 下载
# 选择 "ASP.NET Core Runtime 9.0.x - Windows Hosting Bundle"
```

#### 1.2 创建目录结构
```powershell
# 创建MediaMinder目录
New-Item -ItemType Directory -Path "C:\ProgramData\MediaMinder" -Force
New-Item -ItemType Directory -Path "C:\ProgramData\MediaMinder\Photos" -Force
New-Item -ItemType Directory -Path "C:\ProgramData\MediaMinder\Logs" -Force
New-Item -ItemType Directory -Path "C:\ProgramData\MediaMinder\Config" -Force
New-Item -ItemType Directory -Path "C:\ProgramData\MediaMinder\Temp" -Force
```

#### 1.3 设置权限
```powershell
# 设置目录权限，允许所有用户访问
icacls "C:\ProgramData\MediaMinder" /grant "Users:(OI)(CI)F" /T
icacls "C:\ProgramData\MediaMinder" /grant "Authenticated Users:(OI)(CI)F" /T
```

### 2. 应用程序部署

#### 2.1 发布应用程序
```powershell
# 进入项目目录
cd C:\Users\quying\Projects\MediaMinder

# 发布服务
dotnet publish MediaMinder.Service -c Release -o "C:\ProgramData\MediaMinder\Service"

# 发布UI
dotnet publish MediaMinder.UI -c Release -o "C:\ProgramData\MediaMinder\UI"
```

#### 2.2 复制配置文件
```powershell
# 复制服务配置文件
Copy-Item "MediaMinder.Service\appsettings.json" "C:\ProgramData\MediaMinder\Service\"

# 复制UI配置文件（如果有）
Copy-Item "MediaMinder.UI\appsettings.json" "C:\ProgramData\MediaMinder\UI\" -ErrorAction SilentlyContinue
```

### 3. Windows服务安装

#### 3.1 安装服务
```powershell
# 使用sc命令安装服务
sc create "MediaMinder" binPath="C:\ProgramData\MediaMinder\Service\MediaMinder.Service.exe" start=auto

# 设置服务描述
sc description "MediaMinder" "MediaMinder相机照片管理服务"

# 启动服务
sc start "MediaMinder"
```

#### 3.2 验证服务安装
```powershell
# 检查服务状态
sc query "MediaMinder"

# 检查服务日志
Get-EventLog -LogName Application -Source "MediaMinder" -Newest 10
```

### 4. 自动启动配置

#### 4.1 创建启动脚本
```powershell
# 创建启动脚本
@"
@echo off
cd /d "C:\ProgramData\MediaMinder\UI"
start "" "MediaMinder.UI.exe"
"@ | Out-File -FilePath "C:\ProgramData\MediaMinder\start-ui.bat" -Encoding ASCII
```

#### 4.2 配置开机自启
```powershell
# 方法1: 使用任务计划程序
$action = New-ScheduledTaskAction -Execute "C:\ProgramData\MediaMinder\start-ui.bat"
$trigger = New-ScheduledTaskTrigger -AtStartup
$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
Register-ScheduledTask -TaskName "MediaMinder UI AutoStart" -Action $action -Trigger $trigger -Principal $principal

# 方法2: 使用注册表（需要管理员权限）
$regPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
Set-ItemProperty -Path $regPath -Name "MediaMinder" -Value "C:\ProgramData\MediaMinder\start-ui.bat"
```

### 5. 配置验证

#### 5.1 检查服务状态
```powershell
# 检查服务是否正在运行
Get-Service -Name "MediaMinder"

# 检查服务日志
Get-Content "C:\ProgramData\MediaMinder\Logs\service-*.log" -Tail 20
```

#### 5.2 测试UI启动
```powershell
# 手动启动UI进行测试
cd "C:\ProgramData\MediaMinder\UI"
.\MediaMinder.UI.exe
```

#### 5.3 测试相机连接
1. 连接相机到USB端口
2. 检查服务日志中的设备检测信息
3. 验证照片下载功能

## 配置管理

### 1. 服务配置

#### 1.1 基本配置
```json
{
  "ServiceSettings": {
    "CameraService": {
      "Enabled": true,
      "TargetDirectory": "C:\\ProgramData\\MediaMinder\\Photos",
      "CooldownSeconds": 30
    },
    "PhotoDisplayService": {
      "Enabled": true,
      "PhotosDirectory": "C:\\ProgramData\\MediaMinder\\Photos"
    }
  }
}
```

#### 1.2 相机品牌配置
```json
{
  "CameraService": {
    "CameraDrivePrefixes": [
      "Canon G16", "Canon EOS", "Nikon", "Sony"
    ]
  }
}
```

#### 1.3 日志配置
```json
{
  "Serilog": {
    "MinimumLevel": "Information",
    "WriteTo": [
      {
        "Name": "File",
        "Args": {
          "path": "C:\\ProgramData\\MediaMinder\\Logs\\service-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30
        }
      }
    ]
  }
}
```

### 2. 环境变量配置

#### 2.1 设置环境变量
```powershell
# 设置照片目录环境变量
[Environment]::SetEnvironmentVariable("MEDIAMINDER_PHOTOS_DIR", "C:\ProgramData\MediaMinder\Photos", "Machine")

# 设置日志级别环境变量
[Environment]::SetEnvironmentVariable("MEDIAMINDER_LOG_LEVEL", "Information", "Machine")
```

#### 2.2 在配置中使用环境变量
```json
{
  "ServiceSettings": {
    "PhotoDisplayService": {
      "PhotosDirectory": "%MEDIAMINDER_PHOTOS_DIR%"
    }
  },
  "Serilog": {
    "MinimumLevel": "%MEDIAMINDER_LOG_LEVEL%"
  }
}
```

## 监控和维护

### 1. 日志监控

#### 1.1 日志文件位置
- **服务日志**: `C:\ProgramData\MediaMinder\Logs\service-*.log`
- **事件日志**: Windows事件查看器 > 应用程序 > MediaMinder

#### 1.2 日志分析
```powershell
# 查看最新的服务日志
Get-Content "C:\ProgramData\MediaMinder\Logs\service-*.log" -Tail 50

# 搜索错误日志
Select-String -Path "C:\ProgramData\MediaMinder\Logs\*.log" -Pattern "ERROR|Exception"

# 统计日志级别
Select-String -Path "C:\ProgramData\MediaMinder\Logs\*.log" -Pattern "\[(INFO|WARN|ERROR|DEBUG)\]" | Group-Object Line
```

### 2. 性能监控

#### 2.1 服务性能
```powershell
# 检查服务进程
Get-Process -Name "MediaMinder.Service" -ErrorAction SilentlyContinue

# 检查内存使用
Get-Process -Name "MediaMinder.Service" | Select-Object ProcessName, WorkingSet, VirtualMemorySize

# 检查CPU使用
Get-Counter "\Process(MediaMinder.Service)\% Processor Time"
```

#### 2.2 磁盘使用
```powershell
# 检查照片目录大小
Get-ChildItem "C:\ProgramData\MediaMinder\Photos" -Recurse | Measure-Object -Property Length -Sum

# 检查日志目录大小
Get-ChildItem "C:\ProgramData\MediaMinder\Logs" -Recurse | Measure-Object -Property Length -Sum
```

### 3. 备份和恢复

#### 3.1 配置备份
```powershell
# 备份配置文件
Copy-Item "C:\ProgramData\MediaMinder\Service\appsettings.json" "C:\Backup\MediaMinder\config-backup-$(Get-Date -Format 'yyyyMMdd').json"

# 备份照片目录
robocopy "C:\ProgramData\MediaMinder\Photos" "C:\Backup\MediaMinder\Photos" /E /R:3 /W:10
```

#### 3.2 数据恢复
```powershell
# 恢复配置文件
Copy-Item "C:\Backup\MediaMinder\config-backup-20241220.json" "C:\ProgramData\MediaMinder\Service\appsettings.json"

# 恢复照片目录
robocopy "C:\Backup\MediaMinder\Photos" "C:\ProgramData\MediaMinder\Photos" /E /R:3 /W:10
```

## 故障排除

### 1. 常见问题

#### 1.1 服务无法启动
```powershell
# 检查服务状态
sc query "MediaMinder"

# 查看服务日志
Get-EventLog -LogName Application -Source "MediaMinder" -Newest 10

# 检查.NET Runtime
dotnet --list-runtimes

# 重新安装服务
sc delete "MediaMinder"
sc create "MediaMinder" binPath="C:\ProgramData\MediaMinder\Service\MediaMinder.Service.exe" start=auto
```

#### 1.2 相机无法识别
```powershell
# 检查USB设备
Get-PnpDevice -Class USB

# 检查驱动器
Get-WmiObject -Class Win32_LogicalDisk

# 检查服务日志中的设备检测信息
Select-String -Path "C:\ProgramData\MediaMinder\Logs\*.log" -Pattern "设备插入|相机识别"
```

#### 1.3 UI无法启动
```powershell
# 检查UI进程
Get-Process -Name "MediaMinder.UI" -ErrorAction SilentlyContinue

# 检查依赖项
dotnet --list-runtimes

# 手动启动UI查看错误
cd "C:\ProgramData\MediaMinder\UI"
.\MediaMinder.UI.exe
```

### 2. 日志分析

#### 2.1 错误日志分析
```powershell
# 查找ERROR级别的日志
Select-String -Path "C:\ProgramData\MediaMinder\Logs\*.log" -Pattern "\[ERROR\]"

# 查找异常信息
Select-String -Path "C:\ProgramData\MediaMinder\Logs\*.log" -Pattern "Exception|Error"

# 统计错误类型
Select-String -Path "C:\ProgramData\MediaMinder\Logs\*.log" -Pattern "\[ERROR\]" | Group-Object Line
```

#### 2.2 性能日志分析
```powershell
# 查找性能相关日志
Select-String -Path "C:\ProgramData\MediaMinder\Logs\*.log" -Pattern "下载完成|处理时间|内存使用"

# 统计操作次数
Select-String -Path "C:\ProgramData\MediaMinder\Logs\*.log" -Pattern "照片下载|相机识别" | Measure-Object
```

## 升级和维护

### 1. 应用程序升级

#### 1.1 停止服务
```powershell
# 停止服务
sc stop "MediaMinder"

# 等待服务完全停止
Start-Sleep -Seconds 5
```

#### 1.2 备份当前版本
```powershell
# 备份当前版本
Copy-Item "C:\ProgramData\MediaMinder\Service" "C:\Backup\MediaMinder\Service-$(Get-Date -Format 'yyyyMMdd')" -Recurse
Copy-Item "C:\ProgramData\MediaMinder\UI" "C:\Backup\MediaMinder\UI-$(Get-Date -Format 'yyyyMMdd')" -Recurse
```

#### 1.3 部署新版本
```powershell
# 发布新版本
dotnet publish MediaMinder.Service -c Release -o "C:\ProgramData\MediaMinder\Service"
dotnet publish MediaMinder.UI -c Release -o "C:\ProgramData\MediaMinder\UI"

# 恢复配置文件
Copy-Item "C:\Backup\MediaMinder\Service-20241220\appsettings.json" "C:\ProgramData\MediaMinder\Service\"
```

#### 1.4 启动服务
```powershell
# 启动服务
sc start "MediaMinder"

# 验证服务状态
sc query "MediaMinder"
```

### 2. 定期维护

#### 2.1 日志清理
```powershell
# 清理30天前的日志文件
Get-ChildItem "C:\ProgramData\MediaMinder\Logs\*.log" | Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-30)} | Remove-Item

# 清理临时文件
Get-ChildItem "C:\ProgramData\MediaMinder\Temp\*" | Remove-Item -Force
```

#### 2.2 备份清理
```powershell
# 清理超过1周的备份目录
Get-ChildItem "C:\ProgramData\MediaMinder\Photos\Backup_*" | Where-Object {$_.CreationTime -lt (Get-Date).AddDays(-7)} | Remove-Item -Recurse -Force
```

## 安全考虑

### 1. 权限管理
- 使用最小必要权限运行服务
- 定期审查文件访问权限
- 限制配置文件访问权限

### 2. 数据保护
- 定期备份重要数据
- 加密敏感配置文件
- 监控异常访问

### 3. 网络安全
- 虽然MediaMinder不涉及网络，但确保系统安全更新
- 定期更新.NET Runtime
- 监控系统安全日志

## 总结

本部署指南提供了MediaMinder系统的完整部署流程，包括：

1. **环境准备**: 系统要求和环境配置
2. **应用部署**: 应用程序发布和安装
3. **服务配置**: Windows服务安装和配置
4. **监控维护**: 日志监控和性能监控
5. **故障排除**: 常见问题解决方案
6. **升级维护**: 应用程序升级和定期维护

遵循本指南可以确保MediaMinder系统在生产环境中稳定运行。
