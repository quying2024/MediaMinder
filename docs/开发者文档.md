# MediaMinder å¼€å‘è€…æ–‡æ¡£

## å¼€å‘ç¯å¢ƒè®¾ç½®

### 1. ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Windows 10/11 æˆ– Windows Server 2019/2022
- **å¼€å‘å·¥å…·**: Visual Studio 2022 æˆ– Visual Studio Code
- **.NET SDK**: .NET 9.0 SDK
- **Git**: ç‰ˆæœ¬æ§åˆ¶å·¥å…·
- **PowerShell**: ç”¨äºè„šæœ¬æ‰§è¡Œ

### 2. å¼€å‘å·¥å…·å®‰è£…

#### 2.1 å®‰è£….NET 9.0 SDK
```powershell
# ä¸‹è½½å¹¶å®‰è£….NET 9.0 SDK
# ä» https://dotnet.microsoft.com/download/dotnet/9.0 ä¸‹è½½
# é€‰æ‹© ".NET 9.0 SDK"
```

#### 2.2 å®‰è£…Visual Studio 2022
```powershell
# å®‰è£…Visual Studio 2022 Community/Professional/Enterprise
# ç¡®ä¿å®‰è£…ä»¥ä¸‹å·¥ä½œè´Ÿè½½ï¼š
# - .NET æ¡Œé¢å¼€å‘
# - Windows åº”ç”¨å¼€å‘
# - .NET è·¨å¹³å°å¼€å‘
```

#### 2.3 å®‰è£…Git
```powershell
# ä¸‹è½½å¹¶å®‰è£…Git for Windows
# ä» https://git-scm.com/download/win ä¸‹è½½
```

### 3. é¡¹ç›®è®¾ç½®

#### 3.1 å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/your-org/MediaMinder.git
cd MediaMinder
```

#### 3.2 è¿˜åŸä¾èµ–
```powershell
dotnet restore
```

#### 3.3 æ„å»ºé¡¹ç›®
```powershell
dotnet build
```

## é¡¹ç›®ç»“æ„è¯¦è§£

### 1. è§£å†³æ–¹æ¡ˆç»“æ„
```
MediaMinder/
â”œâ”€â”€ MediaMinder.sln                 # è§£å†³æ–¹æ¡ˆæ–‡ä»¶
â”œâ”€â”€ MediaMinder.Common/             # å…±äº«åº“é¡¹ç›®
â”‚   â”œâ”€â”€ MediaMinder.Common.csproj   # é¡¹ç›®æ–‡ä»¶
â”‚   â”œâ”€â”€ ServiceSettings.cs          # é…ç½®æ¨¡å‹
â”‚   â”œâ”€â”€ MessageTypes.cs             # æ¶ˆæ¯ç±»å‹
â”‚   â”œâ”€â”€ PhotoInfo.cs                # ç…§ç‰‡ä¿¡æ¯æ¨¡å‹
â”‚   â”œâ”€â”€ IPCMessage.cs               # IPCæ¶ˆæ¯æ¨¡å‹
â”‚   â”œâ”€â”€ ICommunicationService.cs    # é€šä¿¡æœåŠ¡æ¥å£
â”‚   â””â”€â”€ CommunicationProtocol.cs    # é€šä¿¡åè®®
â”œâ”€â”€ MediaMinder.Service/            # åå°æœåŠ¡é¡¹ç›®
â”‚   â”œâ”€â”€ MediaMinder.Service.csproj  # é¡¹ç›®æ–‡ä»¶
â”‚   â”œâ”€â”€ Program.cs                  # æœåŠ¡å…¥å£ç‚¹
â”‚   â”œâ”€â”€ CameraService.cs            # ç›¸æœºæœåŠ¡
â”‚   â”œâ”€â”€ PhotoDisplayService.cs      # ç…§ç‰‡å±•ç¤ºæœåŠ¡
â”‚   â”œâ”€â”€ NamedPipeCommunicationService.cs # é€šä¿¡æœåŠ¡
â”‚   â””â”€â”€ appsettings.json            # é…ç½®æ–‡ä»¶
â”œâ”€â”€ MediaMinder.UI/                 # ç”¨æˆ·ç•Œé¢é¡¹ç›®
â”‚   â”œâ”€â”€ MediaMinder.UI.csproj       # é¡¹ç›®æ–‡ä»¶
â”‚   â”œâ”€â”€ Program.cs                  # UIå…¥å£ç‚¹
â”‚   â”œâ”€â”€ PhotoDisplayForm.cs         # ä¸»çª—ä½“
â”‚   â”œâ”€â”€ PhotoDisplayForm.Designer.cs # çª—ä½“è®¾è®¡å™¨
â”‚   â”œâ”€â”€ NamedPipeClient.cs          # é€šä¿¡å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ ProcessManager.cs           # è¿›ç¨‹ç®¡ç†
â”‚   â”œâ”€â”€ AutoStartManager.cs         # è‡ªåŠ¨å¯åŠ¨ç®¡ç†
â”‚   â”œâ”€â”€ PhotoBackupCleanupService.cs # å¤‡ä»½æ¸…ç†æœåŠ¡
â”‚   â””â”€â”€ PhotoBackupCleanupProcess.cs # å¤‡ä»½æ¸…ç†è¿›ç¨‹
â””â”€â”€ docs/                           # é¡¹ç›®æ–‡æ¡£
    â”œâ”€â”€ é¡¹ç›®åˆ›å»ºæ€»ç»“.md
    â”œâ”€â”€ æŠ€æœ¯æ¶æ„æ–‡æ¡£.md
    â”œâ”€â”€ åŠŸèƒ½ç‰¹æ€§æ–‡æ¡£.md
    â”œâ”€â”€ éƒ¨ç½²æŒ‡å—.md
    â”œâ”€â”€ ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ.md
    â””â”€â”€ å¼€å‘è€…æ–‡æ¡£.md
```

### 2. é¡¹ç›®ä¾èµ–å…³ç³»
```mermaid
graph TD
    A[MediaMinder.UI] --> B[MediaMinder.Common]
    C[MediaMinder.Service] --> B[MediaMinder.Common]
    A --> D[System.Drawing.Common]
    A --> E[Microsoft.Extensions.Logging]
    C --> F[Microsoft.Extensions.Hosting]
    C --> G[Serilog]
    C --> H[System.Management]
```

## æ ¸å¿ƒç»„ä»¶å¼€å‘

### 1. å…±äº«åº“ (MediaMinder.Common)

#### 1.1 é…ç½®æ¨¡å‹å¼€å‘
```csharp
// ServiceSettings.cs
public class ServiceSettings
{
    public CameraServiceSettings CameraService { get; set; } = new();
    public PhotoDisplayServiceSettings PhotoDisplayService { get; set; } = new();
    public CommunicationSettings Communication { get; set; } = new();
}

public class CameraServiceSettings
{
    public bool Enabled { get; set; } = true;
    public string[] CameraDrivePrefixes { get; set; } = Array.Empty<string>();
    public string DcimPath { get; set; } = "DCIM";
    public string TargetDirectory { get; set; } = string.Empty;
    
    public CameraIdentificationSettings Identification { get; set; } = new();
    public ConnectionOptimizationSettings ConnectionOptimization { get; set; } = new();
    public DownloadSettings Download { get; set; } = new();
}
```

#### 1.2 æ¶ˆæ¯ç±»å‹å®šä¹‰
```csharp
// MessageTypes.cs
public enum MessageType
{
    StatusUpdate,
    NewPhotosAvailable,
    CameraEvent,
    SourceFilesDeleted
}

public enum CameraEventType
{
    DeviceInserted,
    DeviceRemoved,
    CameraIdentified,
    DownloadStarted,
    DownloadCompleted,
    DownloadFailed,
    SourceFilesDeleted
}
```

#### 1.3 æ•°æ®æ¨¡å‹
```csharp
// PhotoInfo.cs
public class PhotoInfo
{
    public string FileName { get; set; } = string.Empty;
    public string FullPath { get; set; } = string.Empty;
    public long FileSize { get; set; }
    public DateTime CreatedTime { get; set; }
    public DateTime ModifiedTime { get; set; }
    public string Extension { get; set; } = string.Empty;
    public bool IsNew { get; set; }
    public string SourceDevice { get; set; } = string.Empty;
}

// IPCMessage.cs
public class IPCMessage
{
    public MessageType Type { get; set; }
    public object? Data { get; set; }
    public string Source { get; set; } = string.Empty;
    public DateTime Timestamp { get; set; } = DateTime.Now;
    
    public static IPCMessage Create(MessageType type, object? data, string source)
    {
        return new IPCMessage { Type = type, Data = data, Source = source };
    }
}
```

### 2. åå°æœåŠ¡ (MediaMinder.Service)

#### 2.1 æœåŠ¡å…¥å£ç‚¹
```csharp
// Program.cs
var builder = Host.CreateApplicationBuilder(args);

// é…ç½®æœåŠ¡
builder.Services.Configure<ServiceSettings>(
    builder.Configuration.GetSection("ServiceSettings"));

// æ³¨å†ŒæœåŠ¡
builder.Services.AddSingleton<ICommunicationService, NamedPipeCommunicationService>();
builder.Services.AddSingleton<CameraService>();
builder.Services.AddSingleton<PhotoDisplayService>();

// é…ç½®æ—¥å¿—
builder.Services.AddSerilog((services, lc) => lc
    .ReadFrom.Configuration(builder.Configuration)
    .ReadFrom.Services(services));

// æ„å»ºå¹¶è¿è¡Œ
var host = builder.Build();
await host.RunAsync();
```

#### 2.2 ç›¸æœºæœåŠ¡å¼€å‘
```csharp
// CameraService.cs
public class CameraService : IDisposable
{
    private readonly ILogger<CameraService> _logger;
    private readonly ServiceSettings _settings;
    private readonly ICommunicationService _communicationService;
    private ManagementEventWatcher? _deviceWatcher;
    
    public async Task StartAsync(CancellationToken cancellationToken)
    {
        // å¯åŠ¨è®¾å¤‡ç›‘æ§
        StartDeviceMonitoring();
        
        // å‘é€æœåŠ¡å¯åŠ¨æ¶ˆæ¯
        await _communicationService.SendMessageAsync(
            IPCMessage.Create(MessageType.StatusUpdate, "ç›¸æœºæœåŠ¡å·²å¯åŠ¨", "CameraService"));
    }
    
    private void StartDeviceMonitoring()
    {
        var query = new WqlEventQuery("SELECT * FROM Win32_VolumeChangeEvent WHERE EventType = 2");
        _deviceWatcher = new ManagementEventWatcher(query);
        _deviceWatcher.EventArrived += OnDeviceInserted;
        _deviceWatcher.Start();
    }
    
    private async void OnDeviceInserted(object sender, EventArrivedEventArgs e)
    {
        // å¤„ç†è®¾å¤‡æ’å…¥äº‹ä»¶
        var driveName = e.NewEvent["DriveName"]?.ToString();
        if (string.IsNullOrEmpty(driveName)) return;
        
        // æ£€æŸ¥è®¾å¤‡æ’å…¥å†·å´æ—¶é—´
        if (IsDeviceInCooldown(driveName)) return;
        
        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨é»‘åå•ä¸­
        if (IsDeviceBlacklisted(driveName)) return;
        
        // ç­‰å¾…è®¾å¤‡ç¨³å®š
        await Task.Delay(_settings.CameraService.ConnectionOptimization.DeviceStabilizationDelayMs);
        
        // è¯†åˆ«ç›¸æœº
        if (IsCameraDevice(driveName))
        {
            await DownloadPhotosFromCamera(driveName);
        }
    }
}
```

#### 2.3 ç…§ç‰‡å±•ç¤ºæœåŠ¡å¼€å‘
```csharp
// PhotoDisplayService.cs
public class PhotoDisplayService : IDisposable
{
    private readonly ILogger<PhotoDisplayService> _logger;
    private readonly ServiceSettings _settings;
    private readonly ICommunicationService _communicationService;
    private FileSystemWatcher? _fileWatcher;
    
    public async Task StartAsync(CancellationToken cancellationToken)
    {
        // ç¡®ä¿ç…§ç‰‡ç›®å½•å­˜åœ¨
        EnsurePhotosDirectoryExists();
        
        // å¯åŠ¨æ–‡ä»¶ç›‘æ§
        StartFileMonitoring();
        
        // å‘é€æœåŠ¡å¯åŠ¨æ¶ˆæ¯
        await _communicationService.SendMessageAsync(
            IPCMessage.Create(MessageType.StatusUpdate, "ç…§ç‰‡å±•ç¤ºæœåŠ¡å·²å¯åŠ¨", "PhotoDisplayService"));
    }
    
    private void StartFileMonitoring()
    {
        _fileWatcher = new FileSystemWatcher(_settings.PhotoDisplayService.PhotosDirectory)
        {
            NotifyFilter = NotifyFilters.CreationTime | NotifyFilters.LastWrite | NotifyFilters.FileName,
            IncludeSubdirectories = false,
            EnableRaisingEvents = true
        };
        
        _fileWatcher.Created += OnFileCreated;
        _fileWatcher.Changed += OnFileChanged;
        _fileWatcher.Error += OnFileWatcherError;
    }
    
    private async void OnFileCreated(object sender, FileSystemEventArgs e)
    {
        await HandleFileEvent(e, "æ–‡ä»¶åˆ›å»º");
    }
    
    private async Task HandleFileEvent(FileSystemEventArgs e, string eventType)
    {
        if (e.FullPath == null) return;
        
        var extension = Path.GetExtension(e.FullPath).ToLowerInvariant();
        if (!_settings.PhotoDisplayService.SupportedExtensions.Contains(extension))
            return;
        
        // ç­‰å¾…æ–‡ä»¶å†™å…¥å®Œæˆ
        await Task.Delay(1000);
        
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯è®¿é—®
        if (!IsFileAccessible(e.FullPath)) return;
        
        // åˆ›å»ºç…§ç‰‡ä¿¡æ¯
        var photoInfo = await CreatePhotoInfo(e.FullPath);
        if (photoInfo != null)
        {
            // å‘é€æ–°ç…§ç‰‡ä¿¡æ¯
            await _communicationService.SendMessageAsync(
                IPCMessage.Create(MessageType.NewPhotosAvailable, photoInfo, "PhotoDisplayService"));
        }
    }
}
```

### 3. ç”¨æˆ·ç•Œé¢ (MediaMinder.UI)

#### 3.1 ä¸»çª—ä½“å¼€å‘
```csharp
// PhotoDisplayForm.cs
public partial class PhotoDisplayForm : Form
{
    private readonly ICommunicationService _communicationService;
    private readonly CommunicationSettings _settings;
    private readonly List<PhotoInfo> _photos = new();
    private readonly List<PictureBox> _pictureBoxes = new();
    private readonly CancellationTokenSource _refreshCancellationTokenSource = new();
    private readonly string _photosDirectory;
    private bool _isDisposed;
    private Button _btnOpenPhotosFolder;
    
    public PhotoDisplayForm()
    {
        InitializeComponent();
        
        // åˆå§‹åŒ–é…ç½®
        _settings = new CommunicationSettings();
        _communicationService = new NamedPipeClient(_settings);
        _photosDirectory = @"C:\ProgramData\MediaMinder\Photos";
        
        // è®¾ç½®çª—ä½“å±æ€§
        this.Text = "MediaMinder - ç…§ç‰‡å±•ç¤º";
        SetFormSizeToScreenPercentage(0.8);
        this.StartPosition = FormStartPosition.CenterScreen;
        this.FormBorderStyle = FormBorderStyle.Sizable;
        this.MinimumSize = new Size(600, 450);
        
        // åˆå§‹åŒ–UI
        InitializePhotoDisplay();
        SetupCommunication();
    }
    
    private void InitializePhotoDisplay()
    {
        // åˆ›å»ºæ»šåŠ¨é¢æ¿
        var scrollPanel = new Panel
        {
            Dock = DockStyle.Fill,
            AutoScroll = true,
            Padding = new Padding(10)
        };
        
        // åˆ›å»ºä¸»é¢æ¿
        var mainPanel = new TableLayoutPanel
        {
            AutoSize = true,
            AutoSizeMode = AutoSizeMode.GrowAndShrink,
            ColumnCount = 3,
            RowCount = 1,
            Padding = new Padding(5)
        };
        
        // è®¾ç½®åˆ—æ ·å¼
        for (int i = 0; i < 3; i++)
        {
            mainPanel.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 33.33f));
        }
        
        // åˆ›å»ºæŒ‰é’®
        _btnOpenPhotosFolder = new Button
        {
            Text = "ğŸ“ æ‰“å¼€ç…§ç‰‡æ–‡ä»¶å¤¹",
            Font = new Font("Microsoft YaHei", 10, FontStyle.Regular),
            BackColor = Color.FromArgb(0, 120, 215),
            ForeColor = Color.White,
            FlatStyle = FlatStyle.Flat,
            Dock = DockStyle.Bottom,
            Height = 50,
            Margin = new Padding(5),
            Cursor = Cursors.Hand
        };
        
        _btnOpenPhotosFolder.Click += BtnOpenPhotosFolder_Click;
        
        // æ·»åŠ æ§ä»¶
        scrollPanel.Controls.Add(mainPanel);
        this.Controls.Add(scrollPanel);
        this.Controls.Add(_btnOpenPhotosFolder);
        
        // å¯åŠ¨ç…§ç‰‡åˆ·æ–°ä»»åŠ¡
        _ = Task.Run(async () => await RefreshPhotosAsync(_refreshCancellationTokenSource.Token));
    }
}
```

#### 3.2 å¤‡ä»½æ¸…ç†æœåŠ¡å¼€å‘
```csharp
// PhotoBackupCleanupService.cs
public class PhotoBackupCleanupService
{
    private readonly string _photosDirectory;
    private readonly ILogger<PhotoBackupCleanupService> _logger;
    
    public async Task<bool> ExecuteBackupAndCleanupAsync()
    {
        try
        {
            _logger.LogInformation("å¼€å§‹æ‰§è¡Œç…§ç‰‡å¤‡ä»½å’Œæ¸…ç†æ“ä½œ");
            
            // æ£€æŸ¥ä¸‹è½½ç›®å½•æ˜¯å¦å­˜åœ¨
            if (!Directory.Exists(_photosDirectory))
            {
                _logger.LogWarning("ç…§ç‰‡ç›®å½•ä¸å­˜åœ¨: {PhotosDirectory}", _photosDirectory);
                return true;
            }
            
            // è·å–æ ¹ç›®å½•ä¸­çš„æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶
            var imageFiles = GetImageFilesInRootDirectory();
            if (imageFiles.Count == 0)
            {
                _logger.LogInformation("æ ¹ç›®å½•ä¸­æ²¡æœ‰å›¾ç‰‡æ–‡ä»¶ï¼Œè·³è¿‡å¤‡ä»½");
            }
            else
            {
                _logger.LogInformation("æ‰¾åˆ° {Count} ä¸ªå›¾ç‰‡æ–‡ä»¶éœ€è¦å¤‡ä»½", imageFiles.Count);
                
                // åˆ›å»ºæ—¶é—´æˆ³å‘½åçš„å­ç›®å½•
                var backupDirectory = await CreateTimestampedBackupDirectoryAsync();
                if (backupDirectory == null)
                {
                    _logger.LogError("åˆ›å»ºå¤‡ä»½ç›®å½•å¤±è´¥");
                    return false;
                }
                
                // å¤åˆ¶æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•
                var copySuccess = await CopyFilesToBackupDirectoryAsync(imageFiles, backupDirectory);
                if (!copySuccess)
                {
                    _logger.LogError("æ–‡ä»¶å¤åˆ¶å¤±è´¥");
                    return false;
                }
                
                // éªŒè¯å¤åˆ¶ç»“æœ
                var verificationSuccess = await VerifyBackupIntegrityAsync(imageFiles, backupDirectory);
                if (!verificationSuccess)
                {
                    _logger.LogError("å¤‡ä»½éªŒè¯å¤±è´¥");
                    return false;
                }
                
                // åˆ é™¤æ ¹ç›®å½•ä¸­çš„å›¾ç‰‡æ–‡ä»¶
                await DeleteRootDirectoryImagesAsync(imageFiles);
            }
            
            // æ¸…ç†è¿‡æœŸå­ç›®å½•
            await CleanupExpiredDirectoriesAsync();
            
            _logger.LogInformation("ç…§ç‰‡å¤‡ä»½å’Œæ¸…ç†æ“ä½œå®Œæˆ");
            return true;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "æ‰§è¡Œå¤‡ä»½å’Œæ¸…ç†æ“ä½œæ—¶å‘ç”Ÿé”™è¯¯");
            return false;
        }
    }
}
```

## å¼€å‘æœ€ä½³å®è·µ

### 1. ä»£ç è§„èŒƒ

#### 1.1 å‘½åè§„èŒƒ
- **ç±»å**: ä½¿ç”¨PascalCaseï¼Œå¦‚`CameraService`
- **æ–¹æ³•å**: ä½¿ç”¨PascalCaseï¼Œå¦‚`StartAsync`
- **å±æ€§å**: ä½¿ç”¨PascalCaseï¼Œå¦‚`IsEnabled`
- **å­—æ®µå**: ä½¿ç”¨camelCaseï¼Œå¦‚`_logger`
- **å¸¸é‡å**: ä½¿ç”¨PascalCaseï¼Œå¦‚`DefaultTimeout`

#### 1.2 æ³¨é‡Šè§„èŒƒ
```csharp
/// <summary>
/// ç›¸æœºæ£€æµ‹å’Œå›¾ç‰‡ä¸‹è½½æœåŠ¡
/// </summary>
public class CameraService : IDisposable
{
    /// <summary>
    /// å¯åŠ¨ç›¸æœºæœåŠ¡
    /// </summary>
    /// <param name="cancellationToken">å–æ¶ˆä»¤ç‰Œ</param>
    /// <returns>å¼‚æ­¥ä»»åŠ¡</returns>
    public async Task StartAsync(CancellationToken cancellationToken)
    {
        // å®ç°ä»£ç 
    }
}
```

#### 1.3 å¼‚å¸¸å¤„ç†
```csharp
try
{
    // å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„æ“ä½œ
    await SomeAsyncOperation();
}
catch (SpecificException ex)
{
    _logger.LogError(ex, "ç‰¹å®šå¼‚å¸¸å¤„ç†: {Message}", ex.Message);
    // ç‰¹å®šå¤„ç†é€»è¾‘
}
catch (Exception ex)
{
    _logger.LogError(ex, "æœªé¢„æœŸçš„å¼‚å¸¸: {Message}", ex.Message);
    // é€šç”¨å¤„ç†é€»è¾‘
}
```

### 2. å¼‚æ­¥ç¼–ç¨‹

#### 2.1 å¼‚æ­¥æ–¹æ³•
```csharp
public async Task<bool> ProcessPhotosAsync(CancellationToken cancellationToken)
{
    try
    {
        // å¼‚æ­¥æ“ä½œ
        var photos = await GetPhotosAsync(cancellationToken);
        
        // å¹¶è¡Œå¤„ç†
        var tasks = photos.Select(photo => ProcessPhotoAsync(photo, cancellationToken));
        var results = await Task.WhenAll(tasks);
        
        return results.All(r => r);
    }
    catch (OperationCanceledException)
    {
        _logger.LogInformation("æ“ä½œè¢«å–æ¶ˆ");
        return false;
    }
}
```

#### 2.2 å–æ¶ˆä»¤ç‰Œ
```csharp
public async Task LongRunningOperationAsync(CancellationToken cancellationToken)
{
    for (int i = 0; i < 100; i++)
    {
        cancellationToken.ThrowIfCancellationRequested();
        
        // æ‰§è¡Œå·¥ä½œ
        await DoWorkAsync();
        
        // å®šæœŸæ£€æŸ¥å–æ¶ˆ
        if (i % 10 == 0)
        {
            cancellationToken.ThrowIfCancellationRequested();
        }
    }
}
```

### 3. èµ„æºç®¡ç†

#### 3.1 IDisposableå®ç°
```csharp
public class CameraService : IDisposable
{
    private bool _disposed = false;
    private ManagementEventWatcher? _deviceWatcher;
    
    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }
    
    protected virtual void Dispose(bool disposing)
    {
        if (!_disposed)
        {
            if (disposing)
            {
                // é‡Šæ”¾æ‰˜ç®¡èµ„æº
                _deviceWatcher?.Dispose();
            }
            
            // é‡Šæ”¾éæ‰˜ç®¡èµ„æº
            _disposed = true;
        }
    }
}
```

#### 3.2 usingè¯­å¥
```csharp
public async Task ProcessFileAsync(string filePath)
{
    using var fileStream = new FileStream(filePath, FileMode.Open, FileAccess.Read);
    using var reader = new StreamReader(fileStream);
    
    var content = await reader.ReadToEndAsync();
    // å¤„ç†å†…å®¹
}
```

### 4. é…ç½®ç®¡ç†

#### 4.1 å¼ºç±»å‹é…ç½®
```csharp
public class CameraServiceSettings
{
    public bool Enabled { get; set; } = true;
    public string[] CameraDrivePrefixes { get; set; } = Array.Empty<string>();
    public string DcimPath { get; set; } = "DCIM";
    public string TargetDirectory { get; set; } = string.Empty;
    
    [Range(1, 300)]
    public int CooldownSeconds { get; set; } = 30;
    
    [Range(1, 10)]
    public int MaxRetryAttempts { get; set; } = 5;
}
```

#### 4.2 é…ç½®éªŒè¯
```csharp
public class CameraService
{
    private readonly CameraServiceSettings _settings;
    
    public CameraService(IOptions<CameraServiceSettings> settings)
    {
        _settings = settings.Value;
        
        // éªŒè¯é…ç½®
        if (string.IsNullOrEmpty(_settings.TargetDirectory))
        {
            throw new InvalidOperationException("TargetDirectoryä¸èƒ½ä¸ºç©º");
        }
        
        if (_settings.CameraDrivePrefixes.Length == 0)
        {
            throw new InvalidOperationException("CameraDrivePrefixesä¸èƒ½ä¸ºç©º");
        }
    }
}
```

## æµ‹è¯•å¼€å‘

### 1. å•å…ƒæµ‹è¯•

#### 1.1 æµ‹è¯•é¡¹ç›®è®¾ç½®
```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <IsPackable>false</IsPackable>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.8.0" />
    <PackageReference Include="xunit" Version="2.6.1" />
    <PackageReference Include="xunit.runner.visualstudio" Version="2.5.3" />
    <PackageReference Include="coverlet.collector" Version="6.0.0" />
    <PackageReference Include="Moq" Version="4.20.69" />
    <PackageReference Include="FluentAssertions" Version="6.12.0" />
  </ItemGroup>
</Project>
```

#### 1.2 æµ‹è¯•ç¤ºä¾‹
```csharp
[TestClass]
public class CameraServiceTests
{
    private Mock<ILogger<CameraService>> _mockLogger;
    private Mock<ICommunicationService> _mockCommunicationService;
    private CameraServiceSettings _settings;
    private CameraService _cameraService;
    
    [TestInitialize]
    public void Setup()
    {
        _mockLogger = new Mock<ILogger<CameraService>>();
        _mockCommunicationService = new Mock<ICommunicationService>();
        
        _settings = new CameraServiceSettings
        {
            Enabled = true,
            CameraDrivePrefixes = new[] { "Canon G16", "Nikon" },
            DcimPath = "DCIM",
            TargetDirectory = @"C:\Test\Photos"
        };
        
        _cameraService = new CameraService(
            _mockLogger.Object,
            Options.Create(_settings),
            _mockCommunicationService.Object);
    }
    
    [TestMethod]
    public async Task StartAsync_WhenEnabled_ShouldStartSuccessfully()
    {
        // Arrange
        var cancellationToken = CancellationToken.None;
        
        // Act
        await _cameraService.StartAsync(cancellationToken);
        
        // Assert
        _mockCommunicationService.Verify(
            x => x.SendMessageAsync(It.IsAny<IPCMessage>()),
            Times.Once);
    }
    
    [TestMethod]
    public void IsCameraDevice_WithCanonDrive_ShouldReturnTrue()
    {
        // Arrange
        var driveName = "Canon G16";
        
        // Act
        var result = _cameraService.IsCameraDevice(driveName);
        
        // Assert
        result.Should().BeTrue();
    }
}
```

### 2. é›†æˆæµ‹è¯•

#### 2.1 é›†æˆæµ‹è¯•è®¾ç½®
```csharp
[TestClass]
public class CameraServiceIntegrationTests
{
    private ServiceProvider _serviceProvider;
    private CameraService _cameraService;
    
    [TestInitialize]
    public void Setup()
    {
        var services = new ServiceCollection();
        
        // é…ç½®æœåŠ¡
        services.AddLogging(builder => builder.AddConsole());
        services.AddSingleton<ICommunicationService, NamedPipeCommunicationService>();
        services.AddSingleton<CameraService>();
        
        // é…ç½®è®¾ç½®
        var configuration = new ConfigurationBuilder()
            .AddJsonFile("appsettings.test.json")
            .Build();
        
        services.Configure<ServiceSettings>(configuration.GetSection("ServiceSettings"));
        
        _serviceProvider = services.BuildServiceProvider();
        _cameraService = _serviceProvider.GetRequiredService<CameraService>();
    }
    
    [TestMethod]
    public async Task DownloadPhotosFromCamera_WithValidCamera_ShouldDownloadSuccessfully()
    {
        // Arrange
        var driveName = "E:";
        var cancellationToken = CancellationToken.None;
        
        // Act
        var result = await _cameraService.DownloadPhotosFromCamera(driveName);
        
        // Assert
        result.Should().BeTrue();
    }
}
```

## è°ƒè¯•å’Œè¯Šæ–­

### 1. æ—¥å¿—è®°å½•

#### 1.1 ç»“æ„åŒ–æ—¥å¿—
```csharp
_logger.LogInformation("å¼€å§‹ä¸‹è½½ç…§ç‰‡: {DriveName}, æ–‡ä»¶æ•°é‡: {FileCount}", 
    driveName, fileCount);

_logger.LogError(ex, "ä¸‹è½½ç…§ç‰‡å¤±è´¥: {DriveName}, é”™è¯¯: {ErrorMessage}", 
    driveName, ex.Message);

_logger.LogDebug("å¤„ç†æ–‡ä»¶: {FileName}, å¤§å°: {FileSize} bytes", 
    fileName, fileSize);
```

#### 1.2 æ—¥å¿—é…ç½®
```json
{
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console",
        "Args": {
          "outputTemplate": "{Timestamp:HH:mm:ss} [{Level:u3}] {Message:lj}{NewLine}{Exception}"
        }
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/mediaminder-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30
        }
      }
    ]
  }
}
```

### 2. æ€§èƒ½ç›‘æ§

#### 2.1 æ€§èƒ½è®¡æ•°å™¨
```csharp
public class PerformanceMonitor
{
    private readonly ILogger<PerformanceMonitor> _logger;
    private readonly Stopwatch _stopwatch = new();
    
    public async Task<T> MeasureAsync<T>(Func<Task<T>> operation, string operationName)
    {
        _stopwatch.Restart();
        
        try
        {
            var result = await operation();
            _stopwatch.Stop();
            
            _logger.LogInformation("æ“ä½œ {OperationName} å®Œæˆï¼Œè€—æ—¶: {ElapsedMs}ms", 
                operationName, _stopwatch.ElapsedMilliseconds);
            
            return result;
        }
        catch (Exception ex)
        {
            _stopwatch.Stop();
            _logger.LogError(ex, "æ“ä½œ {OperationName} å¤±è´¥ï¼Œè€—æ—¶: {ElapsedMs}ms", 
                operationName, _stopwatch.ElapsedMilliseconds);
            throw;
        }
    }
}
```

#### 2.2 å†…å­˜ç›‘æ§
```csharp
public class MemoryMonitor
{
    private readonly ILogger<MemoryMonitor> _logger;
    
    public void LogMemoryUsage(string context)
    {
        var process = Process.GetCurrentProcess();
        var workingSet = process.WorkingSet64;
        var privateMemory = process.PrivateMemorySize64;
        var gcMemory = GC.GetTotalMemory(false);
        
        _logger.LogInformation("å†…å­˜ä½¿ç”¨æƒ…å†µ - {Context}: å·¥ä½œé›†={WorkingSet}MB, ç§æœ‰å†…å­˜={PrivateMemory}MB, GCå†…å­˜={GCMemory}MB",
            context,
            workingSet / 1024 / 1024,
            privateMemory / 1024 / 1024,
            gcMemory / 1024 / 1024);
    }
}
```

## éƒ¨ç½²å’Œå‘å¸ƒ

### 1. å‘å¸ƒé…ç½®

#### 1.1 å‘å¸ƒè„šæœ¬
```powershell
# publish.ps1
param(
    [string]$Configuration = "Release",
    [string]$OutputPath = ".\publish"
)

Write-Host "å¼€å§‹å‘å¸ƒMediaMinder..." -ForegroundColor Green

# æ¸…ç†è¾“å‡ºç›®å½•
if (Test-Path $OutputPath) {
    Remove-Item $OutputPath -Recurse -Force
}

# å‘å¸ƒæœåŠ¡
Write-Host "å‘å¸ƒMediaMinder.Service..." -ForegroundColor Yellow
dotnet publish MediaMinder.Service -c $Configuration -o "$OutputPath\Service" --self-contained false

# å‘å¸ƒUI
Write-Host "å‘å¸ƒMediaMinder.UI..." -ForegroundColor Yellow
dotnet publish MediaMinder.UI -c $Configuration -o "$OutputPath\UI" --self-contained false

# å¤åˆ¶é…ç½®æ–‡ä»¶
Copy-Item "MediaMinder.Service\appsettings.json" "$OutputPath\Service\"
Copy-Item "MediaMinder.UI\appsettings.json" "$OutputPath\UI\" -ErrorAction SilentlyContinue

Write-Host "å‘å¸ƒå®Œæˆï¼" -ForegroundColor Green
Write-Host "è¾“å‡ºç›®å½•: $OutputPath" -ForegroundColor Cyan
```

#### 1.2 å®‰è£…è„šæœ¬
```powershell
# install.ps1
param(
    [string]$InstallPath = "C:\ProgramData\MediaMinder"
)

Write-Host "å¼€å§‹å®‰è£…MediaMinder..." -ForegroundColor Green

# åˆ›å»ºå®‰è£…ç›®å½•
New-Item -ItemType Directory -Path $InstallPath -Force
New-Item -ItemType Directory -Path "$InstallPath\Photos" -Force
New-Item -ItemType Directory -Path "$InstallPath\Logs" -Force

# å¤åˆ¶æ–‡ä»¶
Copy-Item ".\publish\Service\*" "$InstallPath\Service\" -Recurse -Force
Copy-Item ".\publish\UI\*" "$InstallPath\UI\" -Recurse -Force

# å®‰è£…WindowsæœåŠ¡
Write-Host "å®‰è£…WindowsæœåŠ¡..." -ForegroundColor Yellow
sc create "MediaMinder" binPath="$InstallPath\Service\MediaMinder.Service.exe" start=auto
sc description "MediaMinder" "MediaMinderç›¸æœºç…§ç‰‡ç®¡ç†æœåŠ¡"

# å¯åŠ¨æœåŠ¡
sc start "MediaMinder"

Write-Host "å®‰è£…å®Œæˆï¼" -ForegroundColor Green
```

### 2. ç‰ˆæœ¬ç®¡ç†

#### 2.1 ç‰ˆæœ¬å·ç®¡ç†
```xml
<!-- åœ¨é¡¹ç›®æ–‡ä»¶ä¸­è®¾ç½®ç‰ˆæœ¬ -->
<PropertyGroup>
  <Version>1.0.0</Version>
  <AssemblyVersion>1.0.0.0</AssemblyVersion>
  <FileVersion>1.0.0.0</FileVersion>
  <InformationalVersion>1.0.0</InformationalVersion>
</PropertyGroup>
```

#### 2.2 å‘å¸ƒè¯´æ˜
```markdown
# MediaMinder v1.0.0 å‘å¸ƒè¯´æ˜

## æ–°åŠŸèƒ½
- æ”¯æŒ34ä¸ªç›¸æœºå“ç‰Œè¯†åˆ«
- è‡ªåŠ¨ç…§ç‰‡ä¸‹è½½å’ŒéªŒè¯
- æ™ºèƒ½å¤‡ä»½å’Œæ¸…ç†ç³»ç»Ÿ
- è‡ªé€‚åº”ç…§ç‰‡å±•ç¤ºç•Œé¢
- Photoshopä¼˜å…ˆæ‰“å¼€åŠŸèƒ½

## æ”¹è¿›
- ä¼˜åŒ–çš„è¿æ¥ç¨³å®šæ€§
- æ”¹è¿›çš„é”™è¯¯å¤„ç†
- å¢å¼ºçš„æ—¥å¿—è®°å½•

## ä¿®å¤
- ä¿®å¤äº†æ–‡ä»¶å¥æŸ„å ç”¨é—®é¢˜
- ä¿®å¤äº†UIå“åº”é—®é¢˜
- ä¿®å¤äº†å†…å­˜æ³„æ¼é—®é¢˜

## ç³»ç»Ÿè¦æ±‚
- Windows 10/11
- .NET 9.0 Runtime
- 4GB RAM (æ¨è8GB)
- 1GBå¯ç”¨ç£ç›˜ç©ºé—´
```

## è´¡çŒ®æŒ‡å—

### 1. ä»£ç è´¡çŒ®

#### 1.1 åˆ†æ”¯ç­–ç•¥
- **main**: ä¸»åˆ†æ”¯ï¼Œç”¨äºç”Ÿäº§å‘å¸ƒ
- **develop**: å¼€å‘åˆ†æ”¯ï¼Œç”¨äºé›†æˆå¼€å‘
- **feature/***: åŠŸèƒ½åˆ†æ”¯ï¼Œç”¨äºæ–°åŠŸèƒ½å¼€å‘
- **bugfix/***: ä¿®å¤åˆ†æ”¯ï¼Œç”¨äºbugä¿®å¤
- **release/***: å‘å¸ƒåˆ†æ”¯ï¼Œç”¨äºå‘å¸ƒå‡†å¤‡

#### 1.2 æäº¤è§„èŒƒ
```
<type>(<scope>): <subject>

<body>

<footer>
```

ç±»å‹è¯´æ˜ï¼š
- **feat**: æ–°åŠŸèƒ½
- **fix**: bugä¿®å¤
- **docs**: æ–‡æ¡£æ›´æ–°
- **style**: ä»£ç æ ¼å¼è°ƒæ•´
- **refactor**: ä»£ç é‡æ„
- **test**: æµ‹è¯•ç›¸å…³
- **chore**: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·çš„å˜åŠ¨

#### 1.3 æ‹‰å–è¯·æ±‚
1. Forké¡¹ç›®åˆ°ä¸ªäººä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤ä»£ç å˜æ›´
4. åˆ›å»ºPull Request
5. ä»£ç å®¡æŸ¥
6. åˆå¹¶åˆ°ä¸»åˆ†æ”¯

### 2. é—®é¢˜æŠ¥å‘Š

#### 2.1 é—®é¢˜æ¨¡æ¿
```markdown
## é—®é¢˜æè¿°
ç®€è¦æè¿°é‡åˆ°çš„é—®é¢˜

## é‡ç°æ­¥éª¤
1. æ­¥éª¤1
2. æ­¥éª¤2
3. æ­¥éª¤3

## é¢„æœŸè¡Œä¸º
æè¿°é¢„æœŸçš„è¡Œä¸º

## å®é™…è¡Œä¸º
æè¿°å®é™…å‘ç”Ÿçš„è¡Œä¸º

## ç¯å¢ƒä¿¡æ¯
- æ“ä½œç³»ç»Ÿ: Windows 10/11
- .NETç‰ˆæœ¬: .NET 9.0
- MediaMinderç‰ˆæœ¬: 1.0.0
- ç›¸æœºå“ç‰Œ: Canon/Nikon/Sonyç­‰

## æ—¥å¿—ä¿¡æ¯
```
ç²˜è´´ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯
```

## æˆªå›¾
å¦‚æœé€‚ç”¨ï¼Œè¯·æ·»åŠ æˆªå›¾
```

#### 2.2 åŠŸèƒ½è¯·æ±‚
```markdown
## åŠŸèƒ½æè¿°
ç®€è¦æè¿°è¯·æ±‚çš„åŠŸèƒ½

## ä½¿ç”¨åœºæ™¯
æè¿°è¿™ä¸ªåŠŸèƒ½çš„ä½¿ç”¨åœºæ™¯

## é¢„æœŸæ•ˆæœ
æè¿°æœŸæœ›çš„æ•ˆæœ

## æ›¿ä»£æ–¹æ¡ˆ
æè¿°è€ƒè™‘è¿‡çš„æ›¿ä»£æ–¹æ¡ˆ

## é™„åŠ ä¿¡æ¯
ä»»ä½•å…¶ä»–ç›¸å…³ä¿¡æ¯
```

## æ€»ç»“

æœ¬å¼€å‘è€…æ–‡æ¡£æä¾›äº†MediaMinderé¡¹ç›®çš„å®Œæ•´å¼€å‘æŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š

1. **å¼€å‘ç¯å¢ƒè®¾ç½®**: å¼€å‘å·¥å…·å’Œé¡¹ç›®é…ç½®
2. **é¡¹ç›®ç»“æ„è¯¦è§£**: ä»£ç ç»„ç»‡å’Œä¾èµ–å…³ç³»
3. **æ ¸å¿ƒç»„ä»¶å¼€å‘**: ä¸»è¦ç»„ä»¶çš„å¼€å‘æ–¹æ³•
4. **å¼€å‘æœ€ä½³å®è·µ**: ä»£ç è§„èŒƒå’Œç¼–ç¨‹æ¨¡å¼
5. **æµ‹è¯•å¼€å‘**: å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
6. **è°ƒè¯•å’Œè¯Šæ–­**: æ—¥å¿—è®°å½•å’Œæ€§èƒ½ç›‘æ§
7. **éƒ¨ç½²å’Œå‘å¸ƒ**: å‘å¸ƒé…ç½®å’Œç‰ˆæœ¬ç®¡ç†
8. **è´¡çŒ®æŒ‡å—**: ä»£ç è´¡çŒ®å’Œé—®é¢˜æŠ¥å‘Š

éµå¾ªæœ¬æŒ‡å—å¯ä»¥ç¡®ä¿MediaMinderé¡¹ç›®çš„ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ï¼Œä¸ºé¡¹ç›®çš„é•¿æœŸç»´æŠ¤å’Œæ‰©å±•æä¾›è‰¯å¥½çš„åŸºç¡€ã€‚
